/* MIT License | Copyright (c) 2020 Artem Shmidt
 * Source: https://arte0s.github.io
 */
"use strict";const zoox=(()=>{const e={ZX:Object.freeze({PARAM:"zxBase",BLOCK:"Z",PREFIX:"z",SLOT:"Z-SLOT",IMPL:"z-impl"}),TXT:Object.freeze({BREAK:"\n",TAB:"\t"}),TAG:Object.freeze({STYLE:"STYLE",SCRIPT:"SCRIPT",BODY:"BODY"}),ATTR:Object.freeze({TYPE:"TYPE",ID:"ID"}),CSS:Object.freeze({ALL:"*",ID:"#",ANIM:"@"})},t=(()=>{let n;const r=Object.freeze({oblig:e=>{if(!e)throw new Error("Variable is obligatory!")}});return Object.freeze({isBlock:t=>t.tagName===e.ZX.BLOCK,getBlocks:n=>t.toArray(n.getElementsByTagName(e.ZX.BLOCK)),getId:t=>t.getAttribute(e.ATTR.ID),setDebugMode:e=>n=e,toArray:e=>e?Array.prototype.slice.call(e):[],checks:r,log:(t,r,s)=>"all"==n||n==t?console.log(t,JSON.stringify(r.map(e=>s?((e,t)=>{let n={};return t.forEach(t=>n[t]=e[t]),n})(e,s):e),null,e.TXT.TAB)):null})})(),n=(()=>{const n=[],r=n=>{const r=(e=null,t=[])=>Object.freeze({id:e,components:t}),s=e=>{for(;e&&!t.isBlock(e);)e=e.parentElement;return e},o=e=>t.getBlocks(e).filter(t=>((e,t)=>s(e.parentElement)===s(t))(t,e)).map(e=>t.getId(e));return Object.seal({name:(e=>{const t=e.getAttribute("TYPE");if(!t)throw new Error('For "t" tag you must set one "type" attribute!');return t})(n),id:t.getId(n),impl:(n=>{const s=(n=>t.toArray(n.childNodes).filter(t=>t.classList&&t.classList.contains(e.ZX.IMPL)))(n);return s.length>0?s.map(e=>r(e.getAttribute?t.getId(e):null,o(e))):0!==n.childNodes.length?[r(null,o(n))]:[]})(n)})},s=(()=>{const s=(n,r)=>{if(!n)return;const s=document.createElement(e.TAG.STYLE);return s.setAttribute(e.ATTR.ID,r),t.toArray(n.sheet.cssRules).forEach(t=>{s.innerHTML+=t.cssText.substr(0,1)===e.CSS.ANIM?t.cssText+e.TXT.BREAK+e.TXT.BREAK:e.TXT.BREAK+e.ZX.PREFIX+'[type="'+r+'"] '+t.cssText+e.TXT.BREAK}),s.innerHTML=s.innerHTML.split("{").join("{"+e.TXT.BREAK+e.TXT.TAB),s.innerHTML=s.innerHTML.split(";").join(";"+e.TXT.BREAK+e.TXT.TAB),s.innerHTML=s.innerHTML.split(/[\t] }/).join("}"),s},o=n=>t.toArray(n.getElementsByTagName(e.ZX.SLOT)).map(e=>t.getId(e)),l=e=>{const n=[];return t.isBlock(e)&&n.push(r(e)),t.getBlocks(e).forEach(e=>n.push(r(e))),n};return(e,t,r,i=null)=>{const a=Object.seal({name:i,html:e,css:s(t,i),onCreateFn:r,display:0,slots:o(e),children:l(e),dynCount:0});return n.push(a),a}})(),o=e=>n.find(t=>t.name===e);return{add:s,get:o,getChildName:(e,t)=>o(e).children.find(e=>e.id===t).name,getcId:e=>"dyn"+e.dynCount++,display:e=>{const t=o(e);1==++t.display&&t.css&&document.head.appendChild(t.css)},hide:e=>{const t=o(e);0==--t.display&&t.css&&t.css.parentNode.removeChild(t.css)},log:(...e)=>t.log("TYPES",n,e)}})(),r=(()=>{let e=0;const r=[],l=(e=null)=>r.find(t=>t.id===e),i=e=>{e.visible||(e.visible=!0,n.display(e.type),c(e.id).forEach(e=>i(e)))},a=e=>{e.visible&&(e.visible=!1,n.hide(e.type),c(e.id).forEach(e=>a(e)))},c=(e,t)=>r.filter(n=>t?n.sId===e:n.pId===e),d=e=>(null!==e&&t.checks.oblig(e),{onInit:()=>{},display:()=>(e=>{const t=l(e);console.log("display:",t.type,t.id),t.rootEl.appendChild(t.html),i(t),t.displayFn&&t.displayFn()})(e),hide:()=>(e=>{const t=l(e);if(!t.hideFn||!t.hideFn())return console.log("hide:",t.type,t.id),t.html.parentNode.removeChild(t.html),a(t),!0})(e),getId:()=>e,getHTML:()=>l(e).html,get:t=>((e,t=null,n)=>{const r=c(e,n).find(e=>e.cId===t);if(!r)throw new Error("Control with parent ID '"+e+"' and component ID '"+t+"' not found");return r.zxBase})(e,t,!0),getAll:t=>c(e).map(e=>e.zxBase),setText:(t,n)=>s.create(e,t,n),refreshTexts:()=>s.refresh(e),setDisplayHandler:t=>((e,t)=>l(e).displayFn=t)(e,t),setHideHandler:t=>((e,t)=>l(e).hideFn=t)(e,t),create:(t,n,r,s)=>o.create(e,t,n,r,s),copy:(t,n)=>o.copy(e,t,n)}),u=(e,o)=>{e||(n.log("name","children"),t.log("INST",r),r.forEach(e=>(e=>{const t=l(e),s=r.find(e=>e.id===t.pId),o=n.get(s?s.type:null),i=o?o.children.find(e=>((e,t)=>e.find(e=>!!e.components.find(e=>e===t)))(e.impl,t.cId)):null,a=i?r.filter(e=>e.sId===t.pId).find(e=>e.cId===i.id):null;if(i&&!a)throw new Error("Component '"+i.id+"' in control '"+t.pId+"' not found");a&&(t.pId=a.id)})(e.id))),c(e).forEach(e=>u(e.id,e.zxBase)),o.onInit(),e||s.setLang()};return Object.freeze({createId:t=>t+"-"+e++,add:(e,t,n,s=null,o,l=null,i)=>{const a=((e,t)=>{const n=d(e);return t&&t(n),Object.freeze(n)})(l,n),c=Object.seal({type:s,id:l,cId:o,sId:i,pId:i,rootEl:e,html:t,displayFn:null,hideFn:null,init:()=>u(l,a),zxBase:a,colors:[],texts:[],nodes:[],visible:!1});return r.push(c),c},get:l,getTextData:e=>{const t=l(e);return Object.freeze({html:t.html,nodes:t.nodes,texts:t.texts})},getIds:()=>r.map(e=>e.id)})})(),s=(()=>{let n,s;const o=e=>"{{"+e+"}}",l=(n,r)=>{const s=t.toArray(n.getElementsByTagName(e.CSS.ALL));return s.push(n),s.reduce((e,n)=>e.concat(((e,n)=>t.toArray(e.childNodes).filter(e=>e.nodeType===Node.TEXT_NODE&&-1!==e.textContent.search(o(n))))(n,r)),[])},i=(e,t)=>l(e.html,t).forEach(n=>((e,t,n)=>{const r=e.find(e=>e.el===n);r?r.texts.find(e=>e===t)||r.texts.push(t):e.push(Object.freeze({el:n,text:n.nodeValue,texts:[t]}))})(e.nodes,t,n)),a=(e,t)=>t.forEach((t,n)=>((e,t,n)=>{const r=o(t.id);let s,l=0===n?e.text:e.el.nodeValue;if(t.value===r)throw new Error('Template value "'+t.value+'" and tamplate "'+r+"\"can't be the same!");for(;(s=l.search(r))>=0;)l=l.substr(0,s)+t.value+l.substr(s+r.length);e.el.nodeValue=l})(e,t,n)),c=e=>{const t=r.getTextData(e);t.nodes.forEach(e=>a(e,((e,t)=>e.filter(e=>e.lang===s&&t.find(t=>t===e.id)))(t.texts,e.texts)))};return{create:(e,t,s)=>n.forEach(n=>((e,t,n,s)=>{if(!s)throw new Error('Text no found! id: "'+e+'" textId: "'+t+'" lang: "'+n+'"');const o=r.getTextData(e);o.texts.push(Object.freeze({id:t,lang:n,value:s})),i(o,t)})(e,t,n,s[n])),refresh:e=>{(e=>{const t=r.getTextData(e);t.nodes.length=0,t.texts.filter(e=>e.lang===n[0]).forEach(e=>i(t,e.id))})(e),c(e)},setLangs:e=>{n=e},setLang:e=>{if(e||!s){if(e&&!n.find(t=>t===e))throw new Error('Language "'+e+'" is unknown');e&&(s=e),r.getIds().forEach(e=>c(e))}},getLangs:()=>n.slice(),getLang:()=>s}})(),o=(()=>{const o=(()=>{const t=(()=>{const e=[];return Object.freeze({add:(t,n)=>{const r=e.find(e=>e.name===t);return e.push({name:t,func:n}),r},get:t=>e.filter(e=>e.name===t).map(e=>e.func)})})();return(r,s)=>{const o=n.get(r);o?s(o):t.add(r,s)||(()=>{const s=new XMLHttpRequest;s.open("GET",c+e.ZX.PREFIX+"-"+r+".html",!0),s.onreadystatechange=function(){4===this.readyState&&200===this.status&&((r,s)=>{const o=(new DOMParser).parseFromString(s,"text/html"),l=o.querySelector(e.TAG.STYLE),i=o.querySelector(e.TAG.SCRIPT),a=o.querySelector(e.TAG.BODY).children[0],c=(()=>i?new Function(e.ZX.PARAM,e.TXT.TAB+e.TXT.TAB+"//"+r+e.TXT.BREAK+e.TXT.TAB+e.TXT.TAB+'"use strict";'+e.TXT.BREAK+i.innerText):null)(),d=n.add(a,l,c,r);t.get(r).forEach(e=>e(d))})(r,this.responseText)},s.send()})()}})(),l=(()=>{const s=(n,r,s)=>{r instanceof HTMLElement&&r.setAttribute(e.ATTR.ID,s),n.parentElement.insertBefore(r,n),t.toArray(n.classList).filter(e=>r.classList).forEach(e=>r.classList.add(e))},l=(n,r,o,l,i,a)=>{const c=n.cloneNode(!0);return a&&o.find(e=>e.id===r).impl.forEach(n=>((n,r,o,l)=>{const i=n?r.querySelector(e.CSS.ID+n):r.querySelector(e.ZX.SLOT),a=l+"-"+n,c=o.querySelector(e.CSS.ID+n)||t.toArray(o.childNodes);c instanceof Array?c.forEach((e,t)=>s(i,e,a+"-el"+t)):s(i,c,a),i.parentElement.removeChild(i)})(n.id,c,l,i)),t.toArray(l.classList).forEach(e=>{l.classList.remove(e),c.classList.add(e)}),l.appendChild(c),c},i=(s,a,c,d,u=null,h)=>{if(!a&&c.children.length>1)throw new Error("Attribute `ID` for control doesn't set!");const T=!t.isBlock(d)||d.id!==a&&a?a?d.querySelector(e.CSS.ID+a):t.getBlocks(d)[0]:d,g=r.createId(a);let f;T.setAttribute(e.ATTR.ID,g);s.incFound(),o(h||n.getChildName(c.name,a),e=>{n.display(e.name);const t=l(e.html,a,c.children,T,g,!h),o=r.add(T,t,e.onCreateFn,e.name,a,g,u);h&&(f=o),e.children.forEach(n=>i(s,n.id,e,t,o.id)),s.incInit(),s.isInitEnd()&&(h||(f=r.get()),h||console.time("onInitEnd"),f.init(),s.onInitEnd(f.zxBase),h||console.timeEnd("onInitEnd"))})};return i})(),i=e=>{let t=0,n=0,r=e;return Object.freeze({incFound:()=>t++,incInit:()=>n++,isInitEnd:()=>t===n,onInitEnd:e=>r?r(e):null})},a=(t,s,o,a,c)=>{const d=r.get(t),u=n.get(d?d.type:null);c||(c=n.getcId(u)),((t,n,r)=>{const s=document.createElement(e.ZX.BLOCK);s.setAttribute("type",n),s.setAttribute(e.ATTR.ID,r),t.appendChild(s)})(s,a,c),l(i(o),c,u,d.html,d?d.id:null,a)};let c;return Object.freeze({init:e=>window.addEventListener("load",()=>{c=(e=>{let t;const n=(t=e||"").slice(-1);return t+="/"!==n&&"\\"!==n?"/":""})(e.path),t.setDebugMode(e.debug?e.debug:"none"),s.setLangs(e.langs?e.langs:["en"]);const o=n.add(document.body);r.add(document.body.parentElement,document.body,t=>t.onInit=(()=>e.init(t)));const a=i();o.children.forEach(e=>l(a,e.id,o,o.html))}),create:a,copy:(e,t,n)=>{const s=r.get(t);a(e,s.rootEl.parentElement,n,s.type)},massCopy:(e,t)=>{},free:()=>{}})})();return Object.freeze({init:o.init,utils:Object.freeze({toArray:t.toArray}),setLang:s.setLang,getLangs:s.getLangs,getLang:s.getLang})})();